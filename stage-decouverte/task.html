<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>Liste des stagiaires</title>
	<link rel="stylesheet" href="https://web2018.epfl.ch/8.3.0/css/elements.min.css">
	<script src="https://web2018.epfl.ch/8.3.0/js/elements.min.js"></script>
</head>

<body>
	<header class="header header-light my-2">
		<div class="header-light-content">
			<a class="logo" href="https://www.epfl.ch"><img src="img/epfl_small.png" alt="Logo EPFL"
					class="img-fluid"></a>
			<p class="site-title"><a href="#">Liste des stagiaires</a></p>
			<nav class="nav-lang nav-lang-short ml-auto pr-lg-5"></nav>
		</div>
	</header>

	<div class="breadcrumb-container pb-0 mb-0">
		<nav aria-label="breadcrumb" class="breadcrumb-wrapper" id="breadcrumb-wrapper"></nav>
	</div>
	<div class="main-container m-4">
		<div class="my-1" style="position: relative; max-width: 300px;">
			<input type="text" id="searchInput" placeholder="Rechercher par nom..."
				style="padding-left: 30px; box-sizing: border-box;">
			<svg class="icon" aria-hidden="true"
				style="position: absolute; left: 8px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; pointer-events: none;">
				<use xlink:href="#user"></use>
			</svg>
		</div>
		<div class="my-1" style="position: relative; max-width: 300px;">
			<input type="date" id="dateInput" placeholder="Filtrer par date du stage"
				style="padding-left: 30px; box-sizing: border-box;">
			<svg class="icon" aria-hidden="true"
				style="position: absolute; left: 8px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; pointer-events: none;">
				<use xlink:href="#calendar"></use>
			</svg>
		</div>

		<div>
			<table id="table" class="table table-boxed"></table>
		</div>
	</div>

	<script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
	<script>
		const WEBHOOK_URL = "https://n8n.fsd.epfl.ch/webhook-test/631a3f12-3b64-4853-84da-79774b057273";

		const searchInput = document.getElementById('searchInput');
		const dateInput = document.getElementById('dateInput');
		let allRecords = [];

		window.grist.ready({ requiredAccess: 'full' });

		function calculateAge(birthDate) {
			if (!birthDate) return '';
			const birth = new Date(birthDate);
			const today = new Date();
			let age = today.getFullYear() - birth.getFullYear();
			const monthDiff = today.getMonth() - birth.getMonth();
			if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
				age--;
			}
			return age;
		}

		async function sendEmailWebhook(body) {
			try {
				const response = await fetch(WEBHOOK_URL, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify(body)
				});

				if (response.ok) {
					alert(`Email envoyé à ${record['Prenom_et_nom_First']} ${record['Prenom_et_nom_Last']}`);
				} else {
					alert('Erreur lors de l\'envoi de l\'email');
				}
			} catch (error) {
				console.error('Erreur webhook:', error);
				alert('Erreur de connexion au webhook');
			}
		}

		function renderTable(records) {
			const table = document.getElementById('table');

			while (table.rows.length > 0) table.deleteRow(0);

			if (!records || records.length === 0) {
				const row = table.insertRow();
				const cell = row.insertCell();
				cell.colSpan = 5;
				cell.textContent = 'Aucun stagiaire trouvé.';
				cell.style.textAlign = 'center';
				return;
			}

			const header = table.createTHead();
			const headerRow = header.insertRow();

			['Prénom', 'Nom', 'Date du stage', 'Email', 'Âge', 'Actions'].forEach(title => {
				const th = document.createElement('th');
				th.textContent = title;
				headerRow.appendChild(th);
			});

			for (const rec of records) {
				const row = table.insertRow();
				const prenomCell = row.insertCell();
				prenomCell.textContent = rec['Prenom_et_nom_First'] || '';

				const nomCell = row.insertCell();
				nomCell.textContent = rec['Prenom_et_nom_Last'] || '';

				const dateCell = row.insertCell();
				dateCell.textContent = rec['Date_du_stage'] || '';

				const emailCell = row.insertCell();
				emailCell.textContent = rec.Email || '';

				const ageCell = row.insertCell();
				const age = calculateAge(rec['Date_de_naissance']);
				ageCell.textContent = age ? `${age} ans` : '';

				const actionsCell = row.insertCell();

				const emailBtnInvite = document.createElement('button');
				emailBtnInvite.innerHTML = `
          <svg class="icon" aria-hidden="true">
            <use xlink:href="#mail"></use>
          </svg>
        `;
				emailBtnInvite.title = "Envoyer email invitation";
				emailBtnInvite.style.border = 'none';
				emailBtnInvite.style.cursor = 'pointer';
				emailBtnInvite.style.marginRight = '5px';
				emailBtnInvite.addEventListener('click', async () => {
					const confirmSend = confirm(`Envoyer invitation à ${rec.Email} ?`);
					if (confirmSend) {
						const body = {
							type: 'invitation',
							prenom: rec['Prenom_et_nom_First'] || '',
							nom: rec['Prenom_et_nom_Last'] || '',
							email: rec.Email || '',
							dateStage: rec['Date_du_stage'] || '',
							id: rec.id
						};
						await sendEmailWebhook(body);
					}
				});
				actionsCell.appendChild(emailBtnInvite);

				const emailBtnConfirm = document.createElement('button');
				emailBtnConfirm.innerHTML = `
          <svg class="icon" aria-hidden="true">
            <use xlink:href="#check"></use>
          </svg>
        `;
				emailBtnConfirm.title = "Envoyer email confirmation";
				emailBtnConfirm.style.border = 'none';
				emailBtnConfirm.style.cursor = 'pointer';
				emailBtnConfirm.style.marginRight = '5px';
				emailBtnConfirm.addEventListener('click', async () => {
					const confirmSend = confirm(`Envoyer confirmation à ${rec.Email} ?`);
					if (confirmSend) {
						const body = {
							type: 'confirmation',
							prenom: rec['Prenom_et_nom_First'] || '',
							nom: rec['Prenom_et_nom_Last'] || '',
							email: rec.Email || '',
							dateStage: rec['Date_du_stage'] || '',
							id: rec.id
						};
						await sendEmailWebhook(body);
					}
				});
				actionsCell.appendChild(emailBtnConfirm);

				const emailBtnRapport = document.createElement('button');
				emailBtnRapport.innerHTML = `
          <svg class="icon" aria-hidden="true">
            <use xlink:href="#file"></use>
          </svg>
        `;
				emailBtnRapport.title = "Envoyer le rapport de stage";
				emailBtnRapport.style.border = 'none';
				emailBtnRapport.style.cursor = 'pointer';
				emailBtnRapport.addEventListener('click', async () => {
					const confirmSend = confirm(`Envoyer rapport à ${rec.Email} ?`);
					if (confirmSend) {
						const body = {
							type: 'rapport',
							prenom: rec['Prenom_et_nom_First'] || '',
							nom: rec['Prenom_et_nom_Last'] || '',
							email: rec.Email || '',
							dateStage: rec['Date_du_stage'] || '',
							id: rec.id
						};
						await sendEmailWebhook(body);
					}
				});
				actionsCell.appendChild(emailBtnRapport);
			}
		}

		function applyFilters() {
			const nameQuery = searchInput.value.trim().toLowerCase();
			const dateQuery = dateInput.value.trim();

			console.log('Filtre date appliqué:', dateQuery);

			let filtered = allRecords;

			filtered = filtered.filter(rec => rec['Date_du_stage']);

			if (nameQuery) {
				filtered = filtered.filter(rec => {
					const prenom = (rec['Prenom_et_nom_First'] || '').toLowerCase();
					const nom = (rec['Prenom_et_nom_Last'] || '').toLowerCase();
					return prenom.includes(nameQuery) || nom.includes(nameQuery);
				});
			}
			if (dateQuery) {
				filtered = filtered.filter(rec => {
					const recordDate = String(rec['Date_du_stage']).trim();
					const searchDate = String(dateQuery).trim();
					const match = recordDate === searchDate;
					return match;
				});
			}
			return filtered;
		}

		const eventRenderTable = () => {
			const filtered = applyFilters();
			renderTable(filtered);
		};

		window.grist.onRecords(records => {
			console.log('Nombre de records reçus:', records.length);
			console.log('Premier record:', records[0]);
			allRecords = records;
			if (records.length > 0) {
				console.log('Colonnes disponibles:', Object.keys(records[0]));
			}
			const filtered = applyFilters();
			// renderTable(allRecords); // avec tout
			renderTable(filtered); // avec filtre
		});

		searchInput.addEventListener('input', eventRenderTable);
		dateInput.addEventListener('input', eventRenderTable);
	</script>

	<script>
		svgPath = 'https://web2018.epfl.ch/8.3.0/icons/icons.svg';
		featherSvgPath = 'https://web2018.epfl.ch/8.3.0/icons/feather-sprite.svg';
	</script>
</body>

</html>