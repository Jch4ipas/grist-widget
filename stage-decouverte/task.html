<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>Liste des stagiaires</title>
	<link rel="stylesheet" href="https://web2018.epfl.ch/8.3.0/css/elements.min.css">
	<script src="https://web2018.epfl.ch/8.3.0/js/elements.min.js"></script>
</head>

<body>
	<header class="header header-light my-2">
		<div class="header-light-content">
			<a class="logo" href="https://www.epfl.ch"><img src="img/epfl_small.png" alt="Logo EPFL"
					class="img-fluid"></a>
			<p class="site-title"><a href="#">Liste des stagiaires</a></p>
			<nav class="nav-lang nav-lang-short ml-auto pr-lg-5"></nav>
		</div>
	</header>

	<div class="breadcrumb-container pb-0 mb-0">
		<nav aria-label="breadcrumb" class="breadcrumb-wrapper" id="breadcrumb-wrapper"></nav>
	</div>
	<div class="main-container m-4">
		<div class="my-1" style="position: relative; max-width: 300px;">
			<input type="text" id="searchInput" placeholder="Rechercher par nom..."
				style="padding-left: 30px; box-sizing: border-box;">
			<svg class="icon" aria-hidden="true"
				style="position: absolute; left: 8px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; pointer-events: none;">
				<use xlink:href="#user"></use>
			</svg>
		</div>
		<div class="my-1" style="position: relative; max-width: 300px;">
			<input type="date" id="dateInput" placeholder="Filtrer par date du stage"
				style="padding-left: 30px; box-sizing: border-box;">
			<svg class="icon" aria-hidden="true"
				style="position: absolute; left: 8px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; pointer-events: none;">
				<use xlink:href="#calendar"></use>
			</svg>
		</div>
		<div class="my-1" style="position: relative; max-width: 300px;">
			<input type="button" id="makeContact"
				title="Envoye les infos de tout les stagiaire (afficher actuellement) sur telegram"
				style="padding-left: 30px; box-sizing: border-box;">
			<svg class="icon" aria-hidden="true"
				style="position: absolute; left: 8px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; pointer-events: none;">
				<use xlink:href="#icon-mail-plane"></use>
			</svg>
		</div>
		<div>
			<table id="table" class="table table-boxed"></table>
		</div>
	</div>

	<script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
	<script>
		const WEBHOOK_URL_EMAIL = "https://n8n.fsd.epfl.ch/webhook/631a3f12-3b64-4853-84da-79774b057273";
		const WEBHOOK_URL_CONTACT = "https://n8n.fsd.epfl.ch/webhook/687fa994-84c4-47ea-b2f4-b20efd472130";

		const searchInput = document.getElementById('searchInput');
		const dateInput = document.getElementById('dateInput');
		const sendContactButton = document.getElementById('makeContact');
		let allRecords = [];

		window.grist.ready({ requiredAccess: 'full' });

		function calculateAge(birthDate) {
			if (!birthDate) return '';
			const birth = new Date(birthDate);
			const today = new Date();
			let age = today.getFullYear() - birth.getFullYear();
			const monthDiff = today.getMonth() - birth.getMonth();
			if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
				age--;
			}
			return age;
		}

		async function sendEmailWebhook(body, recordId_updateFieldInGrist, fieldName_updateFieldInGrist, value_updateFieldInGrist) {
			try {
				const response = await fetch(WEBHOOK_URL_EMAIL, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify(body)
				});

				if (response.ok) {
					await updateFieldInGrist(recordId_updateFieldInGrist, fieldName_updateFieldInGrist, value_updateFieldInGrist);
				} else {
					alert('Erreur lors de l\'envoi de l\'email');
				}
			} catch (error) {
				console.error('Erreur webhook:', error);
				alert('Erreur de connexion au webhook');
			}
		}
		async function sendContactWebhook(body) {
			try {
				const response = await fetch(WEBHOOK_URL_CONTACT, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify(body)
				});

				if (response.ok) {
					console.log('Contact envoyer')
				} else {
					alert('Erreur lors de l\'envoi du message');
				}
			} catch (error) {
				console.error('Erreur webhook:', error);
				alert('Erreur de connexion au webhook');
			}
		}

		async function updateFieldInGrist(recordId, fieldName, value) {
			try {
				await window.grist.docApi.applyUserActions([
					['UpdateRecord', 'Extraction_WPForms', recordId, { [fieldName]: value }]
				]);
				console.log(`${fieldName} mis à jour pour le record ${recordId}`);
			} catch (error) {
				console.error('Erreur lors de la mise à jour du champ:', error);
			}
		}

		function renderTable(records) {
			const table = document.getElementById('table');

			while (table.rows.length > 0) table.deleteRow(0);

			if (!records || records.length === 0) {
				const row = table.insertRow();
				const cell = row.insertCell();
				cell.colSpan = 5;
				cell.textContent = 'Aucun stagiaire trouvé.';
				cell.style.textAlign = 'center';
				return;
			}

			const header = table.createTHead();
			const headerRow = header.insertRow();

			['Prénom', 'Nom', 'Date du stage', 'Email', 'Âge', 'Invitation', 'Confirmation', 'Rapport', 'Actions'].forEach(title => {
				const th = document.createElement('th');
				th.textContent = title;
				headerRow.appendChild(th);
			});

			for (const rec of records) {
				const row = table.insertRow();
				const prenomCell = row.insertCell();
				prenomCell.textContent = rec['Prenom'] || '';

				const nomCell = row.insertCell();
				nomCell.textContent = rec['Nom'] || '';

				const dateCell = row.insertCell();
				dateCell.textContent = rec['Date_du_stage'] || '';

				const emailCell = row.insertCell();
				emailCell.textContent = rec.Email || '';

				const ageCell = row.insertCell();
				const age = calculateAge(rec['Date_de_naissance']);
				ageCell.textContent = age ? `${age} ans` : '';

				const emailActions = [
					{ type: 'invitation', title: 'Envoyer email invitation', icon: 'mail', fieldName: 'isInvitationSent' },
					{ type: 'confirmation', title: 'Envoyer email confirmation', icon: 'check', fieldName: 'isConfirmationSent' },
					{ type: 'rapport', title: 'Envoyer le rapport de stage', icon: 'file', fieldName: 'isRapportSent' }
				];

				emailActions.forEach(action => {
					const statusCell = row.insertCell();
					statusCell.textContent = rec[action.fieldName] ? '✓' : '✗';
					statusCell.style.textAlign = 'center';
					statusCell.style.fontWeight = 'bold';
					statusCell.style.color = rec[action.fieldName] ? 'green' : 'red';
				});

				const actionsCell = row.insertCell();

				emailActions.forEach((action, index) => {
					const emailBtn = document.createElement('button');
					emailBtn.innerHTML = `
          <svg class="icon" aria-hidden="true">
            <use xlink:href="#${action.icon}"></use>
          </svg>
        `;
					emailBtn.title = action.title;
					emailBtn.style.border = 'none';
					emailBtn.style.cursor = 'pointer';
					if (index < emailActions.length - 1) {
						emailBtn.style.marginRight = '5px';
					}
					emailBtn.addEventListener('click', async () => {
						const confirmSend = confirm(`Envoyer ${action.type} à ${rec.Email} ?`);
						if (confirmSend) {
							const body = {
								type: action.type,
								prenom: rec['Prenom'] || '',
								nom: rec['Nom'] || '',
								email: rec.Email || '',
								dateStage: rec['Date_du_stage'] || '',
								id: rec.id
							};
							await sendEmailWebhook(body, rec.id, action.fieldName, true);
						}
					});
					actionsCell.appendChild(emailBtn);
				});
			}
		}

		function applyFilters() {
			const nameQuery = searchInput.value.trim().toLowerCase();
			const dateQuery = dateInput.value.trim();

			console.log('Filtre date appliqué:', dateQuery);

			let filtered = allRecords;

			filtered = filtered.filter(rec => rec['Date_du_stage']);

			if (nameQuery) {
				filtered = filtered.filter(rec => {
					const prenom = (rec['Prenom'] || '').toLowerCase();
					const nom = (rec['Nom'] || '').toLowerCase();
					return prenom.includes(nameQuery) || nom.includes(nameQuery);
				});
			}
			if (dateQuery) {
				filtered = filtered.filter(rec => {
					const recordDate = String(rec['Date_du_stage']).trim();
					const searchDate = String(dateQuery).trim();
					const match = recordDate === searchDate;
					return match;
				});
			}
			return filtered;
		}

		const eventRenderTable = () => {
			const filtered = applyFilters();
			renderTable(filtered);
		};

		sendContactButton.addEventListener('click', async () => {
			const confirmSend = confirm(`Envoyer les contacts sur telegram`);
			if (confirmSend) {
				const filtered = applyFilters();
				const body = {
					dateStage: dateInput.value.trim(),
					stagiaire: filtered
				}
				await sendContactWebhook(body);
			}
		});

		window.grist.onRecords(records => {
			console.log('Nombre de records reçus:', records.length);
			console.log('Premier record:', records[0]);
			allRecords = records;
			if (records.length > 0) {
				console.log('Colonnes disponibles:', Object.keys(records[0]));
			}
			const filtered = applyFilters();
			// renderTable(allRecords); // avec tout
			renderTable(filtered); // avec filtre
		});

		searchInput.addEventListener('input', eventRenderTable);
		dateInput.addEventListener('input', eventRenderTable);
	</script>

	<script>
		svgPath = 'https://web2018.epfl.ch/8.3.0/icons/icons.svg';
		featherSvgPath = 'https://web2018.epfl.ch/8.3.0/icons/feather-sprite.svg';
	</script>
</body>

</html>